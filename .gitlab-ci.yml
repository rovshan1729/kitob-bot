before_script:
  - docker login $CI_REGISTRY --username $CI_REGISTRY_USER --password $CI_REGISTRY_PASSWORD
stages:
  - build_staging
  - deploy_staging

build_image_prod:
  stage: build_staging
  image: registry.uicgroup.tech/devops/docker:dind
  before_script:
    - docker login $CI_REGISTRY --username $CI_REGISTRY_USER --password $CI_REGISTRY_PASSWORD
  script:
    - make build-image TAG=$CI_PIPELINE_IID SERVICE_NAME=$CI_PROJECT_NAME PROJECT_NAME=$CI_PROJECT_NAMESPACE REGISTRY=$CI_REGISTRY ENV_TAG=latest
    - make push-image TAG=$CI_PIPELINE_IID SERVICE_NAME=$CI_PROJECT_NAME PROJECT_NAME=$CI_PROJECT_NAMESPACE REGISTRY=$CI_REGISTRY ENV_TAG=latest
  only:
    - master


deploy_image_master:
  image: registry.uicgroup.tech/devops/docker:dind
  stage: deploy_staging
  script:
    - docker service update --with-registry-auth --image registry.uicgroup.tech/sh.nuraddinov/uic-games-bot:$CI_PIPELINE_IID 'uic-games-bot_backend'
    - docker service update --with-registry-auth --image registry.uicgroup.tech/sh.nuraddinov/uic-games-bot:$CI_PIPELINE_IID 'uic-games-bot_bot'
    - docker exec $(docker ps --filter "name=uic-games-bot_backend.*" --format "{{.Names}}" | head -n 1) python manage.py migrate
  only:
    - master
  tags:
    - contaboAz
